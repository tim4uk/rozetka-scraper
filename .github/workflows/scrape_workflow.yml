# .github/workflows/scrape.yml
name: Scrape Rozetka Deliveries

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Посилання на товар Rozetka (наприклад https://rozetka.com.ua/ua/.../p123456789/)'
        required: true
        type: string

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install latest Chrome + Puppeteer
        run: |
          npm install puppeteer@latest

      - name: Run scraper
        id: scrape
        env:
          TARGET_URL: ${{ inputs.url }}
        run: |
          node -e '
          const puppeteer = require("puppeteer");
          const url = process.env.TARGET_URL.trim();

          (async () => {
            const browser = await puppeteer.launch({
              headless: true,
              args: [
                "--no-sandbox",
                "--disable-setuid-sandbox",
                "--disable-dev-shm-usage",
                "--disable-gpu",
                "--no-zygote",
                "--single-process"
              ]
            });

            const page = await browser.newPage();
            await page.setUserAgent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36");

            const deliveries = [];

            page.on("response", async (response) => {
              const reqUrl = response.url();
              if (reqUrl.includes("/v4/deliveries/get-deliveries") && response.status() === 200) {
                deliveries.push(reqUrl);
              }
            });

            const finalUrl = url.includes("#all_sellers") ? url : url + "#all_sellers";

            await page.goto(finalUrl, { waitUntil: "load", timeout: 60000 });

            // чекаємо трохи, бо XHR приходить з затримкою
            await page.waitForTimeout(12000);

            await browser.close();

            const unique = [...new Set(deliveries)];

            if (unique.length === 0) {
              console.log("ПОМИЛКА: не вдалося зловити get-deliveries запит");
              process.exit(1);
            }

            console.log("Знайдені прямі посилання на доставку:");
            unique.forEach(u => console.log(u));

            // виводимо у форматі, який можна забрати через outputs
            console.log("::set-output name=urls::" + JSON.stringify(unique));
          })().catch(err => {
            console.error("Критична помилка:", err.message);
            process.exit(1);
          });
          '

      - name: Show result
        run: |
          echo "Готово! Знайдено ${{ steps.scrape.outputs.urls != '' && 'URL-и' || '0 URL-ів' }}"
