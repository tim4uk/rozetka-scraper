# .github/workflows/rozetka-deliveries.yml
name: Rozetka – Get Deliveries URLs

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Посилання на товар Rozetka (наприклад https://rozetka.com.ua/ua/.../p123456789/)'
        required: true
        type: string

jobs:
  scrape:
    runs-on: ubuntu-latest
    outputs:
      urls: ${{ steps.result.outputs.urls }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Puppeteer 24+
        run: npm install puppeteer@latest

      - name: Run scraper
        id: result
        env:
          TARGET_URL: ${{ inputs.url }}
        run: |
          node -e '
          const puppeteer = require("puppeteer");
          const url = process.env.TARGET_URL.trim();

          (async () => {
            const browser = await puppeteer.launch({
              headless: true,
              args: [
                "--no-sandbox",
                "--disable-setuid-sandbox",
                "--disable-dev-shm-usage",
                "--disable-gpu",
                "--no-zygote",
                "--single-process"
              ]
            });

            const page = await browser.newPage();
            await page.setUserAgent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36");

            const deliveries = [];

            page.on("response", res => {
              const u = res.url();
              if (u.includes("/v4/deliveries/get-deliveries") && res.status() === 200) {
                deliveries.push(u);
              }
            });

            const finalUrl = url.includes("#all_sellers") ? url : url + "#all_sellers";
            console.log("Завантажуємо:", finalUrl);

            await page.goto(finalUrl, { waitUntil: "load", timeout: 60000 });

            // правильна затримка для Puppeteer 24+
            await new Promise(r => setTimeout(r, 14000));

            await browser.close();

            const unique = [...new Set(deliveries)];

            if (unique.length === 0) {
              console.log("ПОМИЛКА: не знайдено жодного запиту get-deliveries");
              process.exit(1);
            }

            console.log("\nЗнайдено", unique.length, "прямих посилань:");
            unique.forEach(u => console.log(u));

            console.log("::set-output name=urls::" + JSON.stringify(unique));
          })().catch(e => {
            console.error("Критична помилка:", e.message);
            process.exit(1);
          });
          '

      - name: Результат
        run: |
          echo "Готово за ~20 секунд!"
          echo "Знайдені прямі API-запити:"
          echo '${{ steps.result.outputs.urls }}' | jq -r '.[]'
